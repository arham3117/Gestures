<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GestureFlow - Hand Gesture Recognition</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }
        .container { max-width: 800px; margin: 0 auto; }
        h1 {
            text-align: center;
            font-size: 2rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .subtitle { text-align: center; color: #888; margin-bottom: 20px; }
        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .video-wrapper {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin: 0 auto;
        }
        #webcam {
            width: 100%;
            border-radius: 8px;
            transform: scaleX(-1);
        }
        #roiBox {
            position: absolute;
            border: 3px solid #00ff88;
            border-radius: 4px;
            pointer-events: none;
            top: 10%;
            right: 5%;
            width: 40%;
            height: 60%;
        }
        #roiLabel {
            position: absolute;
            top: 10%;
            right: 5%;
            transform: translateY(-100%);
            background: #00ff88;
            color: #000;
            padding: 4px 8px;
            font-size: 12px;
            font-weight: bold;
            border-radius: 4px 4px 0 0;
        }
        .hidden { display: none !important; }
        .controls { display: flex; gap: 10px; margin-top: 15px; justify-content: center; }
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-primary {
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            color: #1a1a2e;
        }
        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.2);
        }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .result {
            text-align: center;
            padding: 20px;
        }
        .gesture-name {
            font-size: 2.5rem;
            font-weight: bold;
            text-transform: uppercase;
            margin: 10px 0;
        }
        .confidence { font-size: 1.2rem; color: #00ff88; }
        .predictions { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 15px; }
        .pred-item { min-width: 140px; }
        .pred-label { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 4px; }
        .pred-bar { height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; }
        .pred-fill { height: 100%; background: linear-gradient(90deg, #00d9ff, #00ff88); border-radius: 3px; }
        .tip { background: rgba(0,255,136,0.1); border: 1px solid rgba(0,255,136,0.3); border-radius: 8px; padding: 12px; margin-top: 15px; font-size: 0.85rem; }
        .tip strong { color: #00ff88; }
        .gestures-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .gesture-tag { background: rgba(0,217,255,0.2); padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; }
        canvas { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>GestureFlow</h1>
        <p class="subtitle">Hand Gesture Recognition powered by CNN</p>

        <div class="card">
            <div class="video-wrapper">
                <video id="webcam" autoplay playsinline></video>
                <div id="roiBox" class="hidden"></div>
                <div id="roiLabel" class="hidden">Place hand here</div>
            </div>
            <canvas id="canvas"></canvas>
            <div class="controls">
                <button id="startBtn" class="btn-primary">Start Camera</button>
                <button id="captureBtn" class="btn-secondary" disabled>Capture & Predict</button>
            </div>
            <div class="tip">
                <strong>Tip:</strong> Position your hand inside the green box against a plain background for best results.
            </div>
        </div>

        <div class="card">
            <h3 style="color: #00d9ff; margin-bottom: 10px;">Result</h3>
            <div id="status" style="color: #888; text-align: center;">Start the camera and capture a gesture</div>
            <div id="result" class="result hidden">
                <div>Detected Gesture:</div>
                <div id="gestureName" class="gesture-name">-</div>
                <div id="confidenceText" class="confidence">-</div>
                <div class="predictions" id="predictions"></div>
            </div>
        </div>

        <div class="card">
            <h3 style="color: #00d9ff; margin-bottom: 10px;">Supported Gestures</h3>
            <div class="gestures-list" id="gesturesList"></div>
        </div>
    </div>

    <script>
        const webcam = document.getElementById('webcam');
        const canvas = document.getElementById('canvas');
        const startBtn = document.getElementById('startBtn');
        const captureBtn = document.getElementById('captureBtn');
        const roiBox = document.getElementById('roiBox');
        const roiLabel = document.getElementById('roiLabel');
        const status = document.getElementById('status');
        const result = document.getElementById('result');
        const gestureName = document.getElementById('gestureName');
        const confidenceText = document.getElementById('confidenceText');
        const predictions = document.getElementById('predictions');
        const gesturesList = document.getElementById('gesturesList');

        let stream = null;

        // Load gestures
        fetch('/gestures')
            .then(r => r.json())
            .then(data => {
                gesturesList.innerHTML = data.gestures
                    .map(g => `<span class="gesture-tag">${g.replace('_', ' ')}</span>`)
                    .join('');
            });

        startBtn.addEventListener('click', async () => {
            if (stream) {
                stream.getTracks().forEach(t => t.stop());
                webcam.srcObject = null;
                stream = null;
                startBtn.textContent = 'Start Camera';
                captureBtn.disabled = true;
                roiBox.classList.add('hidden');
                roiLabel.classList.add('hidden');
            } else {
                try {
                    stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: 'user', width: 640, height: 480 }
                    });
                    webcam.srcObject = stream;
                    startBtn.textContent = 'Stop Camera';
                    captureBtn.disabled = false;
                    roiBox.classList.remove('hidden');
                    roiLabel.classList.remove('hidden');
                } catch (e) {
                    status.textContent = 'Camera access denied';
                    status.style.color = '#ff6b6b';
                }
            }
        });

        captureBtn.addEventListener('click', async () => {
            status.textContent = 'Analyzing...';
            status.style.color = '#00d9ff';
            result.classList.add('hidden');

            const vw = webcam.videoWidth;
            const vh = webcam.videoHeight;

            // ROI coordinates (same as training: right 40% of frame, 10-70% height)
            const x1 = Math.floor(vw * 0.5);
            const y1 = Math.floor(vh * 0.1);
            const x2 = Math.floor(vw * 0.9);
            const y2 = Math.floor(vh * 0.7);
            const roiW = x2 - x1;
            const roiH = y2 - y1;

            // Draw full frame to canvas (mirrored like training)
            canvas.width = vw;
            canvas.height = vh;
            const ctx = canvas.getContext('2d');

            // Flip horizontally (same as cv2.flip(frame, 1) in training)
            ctx.translate(vw, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(webcam, 0, 0, vw, vh);

            // Extract ROI from the flipped frame
            const roiCanvas = document.createElement('canvas');
            roiCanvas.width = roiW;
            roiCanvas.height = roiH;
            const roiCtx = roiCanvas.getContext('2d');
            roiCtx.drawImage(canvas, x1, y1, roiW, roiH, 0, 0, roiW, roiH);

            // Send as JPEG
            const imageData = roiCanvas.toDataURL('image/jpeg', 0.9);

            try {
                const response = await fetch('/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: imageData })
                });
                const data = await response.json();

                status.classList.add('hidden');
                result.classList.remove('hidden');

                gestureName.textContent = data.gesture.replace('_', ' ');
                confidenceText.textContent = `${(data.confidence * 100).toFixed(1)}% confidence`;

                predictions.innerHTML = Object.entries(data.all_predictions)
                    .sort((a, b) => b[1] - a[1])
                    .map(([name, val]) => `
                        <div class="pred-item">
                            <div class="pred-label">
                                <span>${name.replace('_', ' ')}</span>
                                <span>${(val * 100).toFixed(1)}%</span>
                            </div>
                            <div class="pred-bar">
                                <div class="pred-fill" style="width: ${val * 100}%"></div>
                            </div>
                        </div>
                    `).join('');
            } catch (e) {
                status.textContent = 'Error: ' + e.message;
                status.style.color = '#ff6b6b';
                status.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
